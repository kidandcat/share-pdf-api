<!DOCTYPE html>
<html>

<head>
    <style>
        #pdf-controls #menu {
            margin-bottom: 10px;
        }
        #pdf-controls .vdrive {
            border: none;
            background: #0089f2;
            padding: 5px;
            padding-left: 10px;
            cursor: pointer;
            padding-right: 10px;
            border-radius: 3px;
            text-shadow: 1px 1px 0 #0072ca;
            color: #fff;
            background-image: linear-gradient(#0089F2 0%, #0050ca 100%);
        }
        #pdf-controls .upload {
            border: none;
            background: lightgrey;
            padding: 5px;
            padding-left: 10px;
            cursor: pointer;
            padding-right: 10px;
            border-radius: 3px;
            text-shadow: 1px 1px 0 grey;
            color: #fff;
            background-image: linear-gradient(lightgrey 0%, grey 100%);
        }
        #pdf-controls .lista {
            margin: 10px;
        }
        #pdf-controls .lista i {
            color: blue;
            display: block;
            cursor: pointer;
            display: inline-block;
            text-decoration: none;
        }
        #pdf-controls .lista a {
            color: gray;
            display: block;
            cursor: pointer;
            display: inline-block;
            text-decoration: none;
            margin-left: 5px;
        }
    </style>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="font-awesome.min.css">
    <!-- <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet"> -->
</head>

<body>


    <div id="pdf-controls">
        <template v-if="noRoom">
            <span>Sala:</span>
            <input type="text" v-model="room" id="room" v-on:keyup.enter="registerRoom" autofocus>
        </template>
        <template v-else>
            <div id="pdf-controls">
                <div id="menu">
                    <button class="vdrive" v-on:click="listVdrive">vDrive</button>
                    <button class="upload" onclick="document.getElementById('file-select').click()" />Upload PDF</button>
                    <input type="file" id="file-select" onchange="pdf.submit()" name="file" style="display: none;" />
                </div>
                <div id="roomFiles">
                    <span>Archivos de la sala <i id="load_list" class="fa fa-refresh" v-on:click="list"></i></span>
                    <div class="lista">
                        <template v-for="file in filesRoom">
                            <div>
                                <i onclick="pdf.open('{{ '/pdf/view/' + file.link.split('pdf/')[1] }}')">{{ decodeURIComponent(file.name) }}</i>
                                <a class="fa fa-external-link" href="{{ '/pdf/view/' + file.link.split('pdf/')[1] }}" target="_blank"></a>
                            </div>
                        </template>
                    </div>
                </div>
                <div id="ownFiles">
                    <span>Mis archivos</span>
                    <div class="lista">
                        <template v-for="file in filesMine">
                            <div>
                                <i onclick="pdf.open('{{ file.path + '/' + file.password }}')">{{ decodeURIComponent(file.name) }}</i>
                                <a class="fa fa-external-link" onclick="window.open('{{ file.path + '/' + file.password }}', '_blank', 'width=600,height=400')"></a>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            <br>
            <div id="pdf-visor">
                {{{ iframe }}}
            </div>
        </template>
    </div>


</body>
<script src="vue.js"></script>
<script src="vue-resource.min.js"></script>
<script>
    var pdf = new Vue({
        el: '#pdf-controls',
        data: {
            room: '',
            noRoom: true,
            iframe: '',
            filesRoom: [
                
            ],
            filesMine: [
                
            ]
        },
        methods: {
            registerRoom: function() {
                console.log('1');
                if(this.room != ''){
                    this.noRoom = false;
                }
            },
            submit: function(){
                var self = this;
                var files = document.getElementById('file-select').files;
                var formData = new FormData();
                formData.append('file', files[0], files[0].name);
                Vue.http.post('/pdf/' + this.room, formData).then(function(res){
                    self.filesMine.push({
                        name: res.data.path.split('/')[2],
                        path: '/pdf/view/' + res.data.path.split('pdf/')[1],
                        password: res.data.password
                    });
                }, function(err){
                    console.log(err);
                });
            },
            list: function(){
                var self = this;
                var spin1 = document.getElementById('load_list');
                spin1.classList.add('fa-spin');
                Vue.http.get('/pdf/list/' + this.room).then(function(res){
                    self.filesRoom = res.data.files;
                    spin1.classList.remove('fa-spin');
                }, function(err){
                    console.log(err);
                    spin1.classList.remove('fa-spin');
                });
            },
            open: function(link){
                var ifr = document.createElement('iframe');
                ifr.setAttribute('id', 'iframe');
                ifr.setAttribute('width', '600');
                ifr.setAttribute('height', '400');
                ifr.setAttribute('src', link);
                ifr.setAttribute('name', 'myFrame');
                var trick = document.createElement('hack');
                trick.appendChild(ifr);
                this.iframe = trick.innerHTML;
            },
            listVdrive: function(){
                var self = this;
                // window.opener.postMessage(true, '*'); //or false
                var top = window.top.outerHeight / 2 + window.top.screenY - ( 500 / 2);
                var left = window.top.outerWidth / 2 + window.top.screenX - ( 500 / 2);
                var ww = window.open('/pdf/vdrive/list/', '_blank', "height=500,width=500, top=" + top + ", left=" + left);
                ww.room = this.room;
                window.addEventListener("message", function(e) {
                    var res = JSON.parse(e.data);
                    self.filesMine.push({
                        name: res.data.path.split('/')[2],
                        path: '/pdf/view/' + res.data.path.split('pdf/')[1],
                        password: res.data.password
                    });
                })
            }
        }
    });
    
    /*

    
    function listVdrive(){
        ajax({method: 'GET', route: '/pdf/vdrive/list/'  + prompt('vDrive user') + '/' + prompt('vDrive pass'), params: null, callback: function(res){
            try{
                var response = JSON.parse(res);
                lista.innerHTML = '';
                var noFirst = false;
                response.forEach(function(file){
                    if(!noFirst){
                        noFirst = true;
                    }else{
                        var ln = file.link.split(':path').join(roomName.value);
                        lista.innerHTML += '<a onclick="importa(\'' + ln + '\')">' + file.name + ' -> Importar</a><br>';
                    }
                });
            }catch(e){
                lista.innerHTML = 'Error: ' + err;
            }
        }});
    }
    
    function importa(link){
        ajax({method: 'GET', route: link, params: null, callback: function(ss){
            var s = JSON.parse(ss);
            lista.innerHTML = '';
            miLista.innerHTML += '<a onclick="openInIframe(\'' + '/pdf/view/' + s.path.split('pdf/')[1] + '/' + s.password + '\')">' + '(master) ' + encodeURIComponent(s.path.split('/')[2]) + '</a><br>';
        }});
    }
    
    function list(){
        ajax({method: 'GET', route: '/pdf/list/' + roomName.value, params: null, callback: function(res){
            var ok = true;
            try{
                var response = JSON.parse(res);
            }catch(e){
                ok = false;
            }
            if(ok && response.files){
                lista.innerHTML = '';
                console.log(response);
                response.files.forEach(function(file){
                    lista.innerHTML += '<a onclick="openInIframe(\'' + '/pdf/view/' + file.link.split('pdf/')[1] + '\')">' + file.name + '</a><br>';
                });
            }else{
                lista.innerHTML = 'Nothing found';
            }
        }});
    }
    list();
    setInterval(function(){list()}, 5000);*/

</script>

</html>