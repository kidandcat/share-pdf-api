<!DOCTYPE html>
<html>

<head>

</head>

<body>
    <form id="pdf-form" action="" method="post" enctype="multipart/form-data">
        <span>Sala:</span>
        <input type="text" id="room">
        <input type="file" id="file-select" name="file" />
        <input type="submit" id="upload-button">
    </form>
    
    <div id="pdf-container">
        <div id="menu">
            <button onclick="list()">Lista</button>
        </div>
        <div id="lista">
            
        </div>
        <div id="miLista">
            
        </div>
    </div>
    <div id="pdf-visor" width="600" height="400">
    </div>
</body>

<script>
    var form = document.getElementById('pdf-form');
    var fileSelect = document.getElementById('file-select');
    var uploadButton = document.getElementById('upload-button');
    var roomName = document.getElementById('room');
    var lista = document.getElementById('lista');
    var miLista = document.getElementById('miLista');
    
    form.onsubmit = function(event) {
        event.preventDefault();
        uploadButton.innerHTML = 'Uploading...';

        var files = fileSelect.files;
        var formData = new FormData();
        formData.append('file', files[0], files[0].name);
        ajax({method: 'POST', route: '/pdf/' + roomName.value, params: formData, callback: function(ss){
            var s = JSON.parse(ss);
            console.log(s);
            miLista.innerHTML += '<a onclick="openInIframe(\'' + '/pdf/view/' + s.link.split('pdf/')[1] + '/' + s.password + '\')">' + s.name + '</a><br>';
        }});
    }
    
    function ajax(input/*method, route, params, callback*/) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (xhttp.readyState == 4 && xhttp.status == 200 && input.callback) {
                input.callback(xhttp.responseText);
            }
        };
        xhttp.open(input.method, input.route + '/' + ((input.method != 'POST' && input.params)?input.params:''), true);
        xhttp.send((input.method == 'POST' && input.params)?input.params:null);
    }
    
    function openInIframe(link){
        var ifr = document.createElement('iframe');
        ifr.setAttribute('id', 'iframe');
        ifr.setAttribute('src', link);
        document.querySelector('#pdf-visor').appendChild(ifr);
    }
    
    function list(){
        ajax({method: 'GET', route: '/pdf/list/' + roomName.value, params: null, callback: function(res){
            var ok = true;
            try{
                var response = JSON.parse(res);
            }catch(e){
                ok = false;
            }
            if(ok && response.files){
                lista.innerHTML = '';
                console.log(response);
                response.files.forEach(function(file){
                    lista.innerHTML += '<a onclick="openInIframe(\'' + '/pdf/view/' + file.link.split('pdf/')[1] + '\')">' + file.name + '</a><br>';
                });
            }else{
                lista.innerHTML = 'Nothing found';
            }
        }});
    }
    
    
</script>

</html>