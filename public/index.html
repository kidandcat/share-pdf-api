<!DOCTYPE html>
<html>

<head>

</head>

<body>

    <span>Sala:</span>
    <input type="text" id="room">
    <br>
    <div id="pdf-container">
        <div id="menu">
            <form id="pdf-form" action="" method="post" enctype="multipart/form-data">
                <button onclick="listVdrive()">vDrive</button>
                <button onclick="document.getElementById('file-select').click()" />Upload PDF</button>
                <input type="file" id="file-select" onchange="document.getElementById('upload-button').click()" name="file" style="display: none;"/>
                <input type="submit" id="upload-button" value="Subir" style="display: none;">
            </form>
        </div>
        <br>
        Archivos de la sala
        <div id="lista">

        </div>
        <br>
        Mis archivos
        <div id="miLista">

        </div>
    </div>
    <br>
    <div id="pdf-visor" width="600" height="400">
    </div>
</body>
<script>
    var form = document.getElementById('pdf-form');
    var fileSelect = document.getElementById('file-select');
    var uploadButton = document.getElementById('upload-button');
    var roomName = document.getElementById('room');
    var lista = document.getElementById('lista');
    var miLista = document.getElementById('miLista');
    
    roomName.value = prompt('Introduce un nombre de sala, se puede modificar despues, pero no puede estar vacio');
    
    form.onsubmit = function(event) {
        event.preventDefault();
        uploadButton.innerHTML = 'Uploading...';

        var files = fileSelect.files;
        var formData = new FormData();
        formData.append('file', files[0], files[0].name);
        ajax({method: 'POST', route: '/pdf/' + roomName.value, params: formData, callback: function(ss){
            var s = JSON.parse(ss);
            console.log(s);
            miLista.innerHTML += '<a onclick="openInIframe(\'' + '/pdf/view/' + s.path.split('pdf/')[1] + '/' + s.password + '\')">' + '(master) ' + encodeURIComponent(s.path.split('/')[2]) + '</a><br>';
        }});
    }
    
    function ajax(input/*method, route, params, callback*/) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (xhttp.readyState == 4 && xhttp.status == 200 && input.callback) {
                input.callback(xhttp.responseText);
            }
        };
        xhttp.open(input.method, input.route + '/' + ((input.method != 'POST' && input.params)?input.params:''), true);
        xhttp.send((input.method == 'POST' && input.params)?input.params:null);
    }
    
    function openInIframe(link){
        var ifr = document.createElement('iframe');
        ifr.setAttribute('id', 'iframe');
        ifr.setAttribute('width', '600');
        ifr.setAttribute('height', '400');
        ifr.setAttribute('src', link);
        document.querySelector('#pdf-visor').innerHTML = '';
        document.querySelector('#pdf-visor').appendChild(ifr);
    }
    
    function listVdrive(){
        ajax({method: 'GET', route: '/pdf/vdrive/list/'  + prompt('vDrive user') + '/' + prompt('vDrive pass'), params: null, callback: function(res){
            try{
                var response = JSON.parse(res);
                lista.innerHTML = '';
                var noFirst = false;
                response.forEach(function(file){
                    if(!noFirst){
                        noFirst = true;
                    }else{
                        var ln = file.link.split(':path').join(roomName.value);
                        lista.innerHTML += '<a onclick="importa(\'' + ln + '\')">' + file.name + ' -> Importar</a><br>';
                    }
                });
            }catch(e){
                lista.innerHTML = 'Error: ' + err;
            }
        }});
    }
    
    function importa(link){
        ajax({method: 'GET', route: link, params: null, callback: function(ss){
            var s = JSON.parse(ss);
            lista.innerHTML = '';
            miLista.innerHTML += '<a onclick="openInIframe(\'' + '/pdf/view/' + s.path.split('pdf/')[1] + '/' + s.password + '\')">' + '(master) ' + encodeURIComponent(s.path.split('/')[2]) + '</a><br>';
        }});
    }
    
    function list(){
        ajax({method: 'GET', route: '/pdf/list/' + roomName.value, params: null, callback: function(res){
            var ok = true;
            try{
                var response = JSON.parse(res);
            }catch(e){
                ok = false;
            }
            if(ok && response.files){
                lista.innerHTML = '';
                console.log(response);
                response.files.forEach(function(file){
                    lista.innerHTML += '<a onclick="openInIframe(\'' + '/pdf/view/' + file.link.split('pdf/')[1] + '\')">' + file.name + '</a><br>';
                });
            }else{
                lista.innerHTML = 'Nothing found';
            }
        }});
    }
    list();
    setInterval(function(){list()}, 5000);

</script>

</html>